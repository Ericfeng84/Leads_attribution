# 营销多渠道归因分析 Python 实现

## 项目概述 (Project Overview)

在当今复杂的营销环境中，客户在最终下单（我们称之为“转化”）之前，往往会通过多种渠道与品牌互动。例如，一个客户可能先通过社交媒体广告了解到产品，几天后通过搜索引擎找到官网，最后因为一封促销邮件而决定购买。

那么，这笔订单的功劳应该如何分配给这些不同的营销渠道呢？**营销归因分析**就是为了解决这个问题。

本项目提供了一个Python脚本，使用Pandas库来实现多种主流的营销归因模型。它能帮助您分析：

*   哪些营销渠道（销售线索来源）对客户的最终购买决策贡献最大？
*   不同的归因模型如何影响我们对渠道效果的评估？

核心逻辑是：**对于每一笔订单，我们回顾该客户在订单发生前90天内的所有营销互动（销售线索），然后根据选定的归因模型，为这些互动分配“功劳点数”。**

## 核心功能 (Core Functionality)

1.  **数据整合**: 自动合并客户的“销售线索数据”（记录了客户什么时间通过什么渠道与我们互动）和“订单数据”（记录了客户什么时间下了多少金额的订单）。
2.  **销售线索有效期**: 严格遵守“每条新销售线索有效期90天”的规则。只有在订单发生前90天内产生的、且早于订单时间的线索，才会被纳入考量范围。
3.  **多种归因模型实现**:
    *   **最终互动模型 (Last Touch/Last Interaction)**: 将100%的功劳归于转化前客户接触的最后一个营销渠道。
    *   **首次互动模型 (First Touch/First Interaction)**: 将100%的功劳归于客户接触的第一个营销渠道。
    *   **线性模型 (Linear)**: 将功劳平均分配给转化路径上所有的营销渠道。
    *   **时间衰减模型 (Time Decay)**: 越接近转化时间的营销互动，获得的功劳越多。脚本中可以设置“半衰期”（例如7天），表示每过一个半衰期，互动的影响力减半。
    *   **位置模型 (Position-Based / U-Shaped)**: 通常给路径中的第一个和最后一个互动较高的固定权重（例如各40%），剩余的权重（例如20%）平均分配给中间的互动。
4.  **结果量化与汇总**:
    *   为每个订单下的每条有效线索计算其应得的“归因分数”（0到1之间，代表功劳占比）。
    *   可以将这些分数与订单金额结合，计算出每个渠道具体贡献了多少销售额。
    *   最终可以汇总查看各个营销渠道在不同模型下的总贡献。

## 工作流程 (How It Works)

脚本的内部工作流程大致如下：

1.  **数据加载与准备 (Data Loading & Preparation)**:
    *   加载包含客户ID、线索时间、线索来源等的`leads_df`（销售线索表）。
    *   加载包含客户ID、订单时间、订单金额等的`orders_df`（订单表）。
    *   确保所有时间戳都转换为Python能理解的日期时间格式。

2.  **关联订单与有效线索 (Linking Orders to Valid Leads)**:
    *   对于系统中的每一笔订单：
        *   找到下这张订单的客户。
        *   查找这位客户在该订单发生**之前**的所有销售线索。
        *   从这些线索中，筛选出那些发生在该订单时间点**往前推90天内**的线索。这些就是对当前订单“可能有效”的线索。
    *   这一步会生成一个 `merged_df`，其中每一行代表一个订单和一个可能对其有贡献的有效线索。

3.  **应用归因模型 (Applying Attribution Models)**:
    *   脚本定义了一个核心函数 `calculate_attribution`。
    *   对于每一个订单及其关联的一组有效线索（我们称之为“转化路径”）：
        *   **最终互动**: 找到路径中时间最晚的线索，给它1分，其他线索0分。
        *   **首次互动**: 找到路径中时间最早的线索，给它1分，其他线索0分。
        *   **线性**: 如果路径上有N个线索，每个线索得 1/N 分。
        *   **时间衰减**: 计算每个线索距离订单发生的天数，根据预设的半衰期（比如7天）用指数衰减公式 `2^(-天数差 / 半衰期)` 计算权重，然后将所有权重归一化（使总和为1）。离订单越近，得分越高。
        *   **位置模型**:
            *   如果只有一个线索，它得1分。
            *   如果有两个线索，按预设的首尾权重比例分配（例如，如果首尾各占40%，则各得50%的功劳）。
            *   如果有三个或更多线索，第一个线索得预设的“首位权重”（如40%），最后一个线索得“末位权重”（如40%），中间所有线索平分剩余的“中间权重”（如20%）。

4.  **结果汇总与解读 (Aggregating Results)**:
    *   `calculate_attribution` 函数会为每个订单的每条相关线索输出一个归因分数。
    *   脚本还提供了 `aggregate_attribution_by_source` 函数，它可以：
        *   将归因分数与订单金额相乘，得到每条线索贡献的“归因价值”。
        *   按“线索来源”（如'Email', 'Social', 'Search'）分组，汇总每个渠道在特定模型下获得的总归因分数、总归因价值以及参与的转化次数。
        *   这能清晰地展示哪些渠道在不同视角下表现最好。

## 数据要求 (Data Requirements)

您需要准备两个主要的数据表（通常是Pandas DataFrame）：

1.  **销售线索数据 (`leads_df`)**:
    *   `lead_id`: 线索的唯一标识。
    *   `customer_id`: 客户的唯一标识。
    *   `lead_timestamp`: 线索发生的时间（需要是日期时间格式）。
    *   `lead_source`: 线索的来源渠道（例如：'Email', 'Social Media', 'Search Engine', 'Referral'）。

2.  **订单数据 (`orders_df`)**:
    *   `order_id`: 订单的唯一标识。
    *   `customer_id`: 客户的唯一标识（用于关联线索）。
    *   `order_timestamp`: 订单发生的时间（需要是日期时间格式）。
    *   `order_value`: 订单的金额（用于计算渠道贡献的价值）。

## 如何使用 (How to Use)

1.  **准备数据**: 按照上述“数据要求”准备您的销售线索和订单数据，并加载为Pandas DataFrame。
2.  **运行脚本**:
    *   将您的数据替换掉脚本中示例的 `leads_df` 和 `orders_df`。
    *   执行整个Python脚本。
3.  **查看结果**:
    *   脚本会为每种归因模型打印出详细的归因结果（哪些线索为哪些订单贡献了多少分数）。
    *   接着，它会展示按渠道汇总的归因分数和归因价值，让您可以直观比较各渠道的表现。

## 业务价值 (Business Value)

*   **优化营销预算分配**: 通过了解哪些渠道最有效地驱动转化，您可以更明智地分配营销预算，将资源投入到回报率最高的渠道。
*   **深入理解客户转化路径**: 分析不同模型的结果可以揭示客户决策过程的复杂性。例如，某些渠道可能擅长“首次触达”并引入新客户，而另一些渠道则更擅长在决策后期“临门一脚”。
*   **更准确地评估渠道ROI**: 传统的“最后点击”模型可能高估某些渠道而低估其他渠道。多模型分析提供了更全面的视角。
*   **数据驱动的营销决策**: 用实际数据支撑您的营销策略调整和优化。

## 进一步探索 (Further Exploration)

*   **自定义参数**: 调整时间衰减模型的“半衰期”或位置模型的权重分配，看看结果如何变化。
*   **可视化**: 将汇总结果用条形图、饼图等可视化方式展示，更直观地比较渠道表现。
*   **集成更多数据源**: 如果有其他类型的客户互动数据（如客服沟通记录、App内行为等），也可以考虑将其纳入分析。
*   **A/B测试**: 基于归因分析的洞察，设计营销活动的A/B测试，验证渠道优化的效果。

希望这个解释能帮助您理解这段代码的业务含义和价值！
